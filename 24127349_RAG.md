## ğŸ—ï¸ Kiáº¿n TrÃºc Cá»‘t LÃµi: RAG (Retrieval-Augmented Generation)

ToÃ n bá»™ há»‡ thá»‘ng Ä‘Æ°á»£c xÃ¢y dá»±ng nhÆ° má»™t API (sá»­ dá»¥ng FastAPI) vÃ  tuÃ¢n theo kiáº¿n trÃºc RAG (Retrieval-Augmented Generation). Luá»“ng hoáº¡t Ä‘á»™ng nÃ y chia lÃ m hai giai Ä‘oáº¡n chÃ­nh:

**Retrieval (Truy váº¥n):** TÃ¬m kiáº¿m vÃ  lá»c thÃ´ng tin (Ä‘á»‹a Ä‘iá»ƒm) phÃ¹ há»£p nháº¥t tá»« cÆ¡ sá»Ÿ dá»¯ liá»‡u.  
**Generation (Táº¡o sinh):** ÄÆ°a thÃ´ng tin Ä‘Ã£ lá»c cho má»™t MÃ´ hÃ¬nh NgÃ´n ngá»¯ Lá»›n (LLM) Ä‘á»ƒ táº¡o ra cÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng cho ngÆ°á»i dÃ¹ng.

---

## ğŸ”‘ Thuáº­t ToÃ¡n & MÃ´ HÃ¬nh Cá»‘t LÃµi

Há»‡ thá»‘ng sá»­ dá»¥ng cÃ¡c thuáº­t toÃ¡n vÃ  mÃ´ hÃ¬nh sau:

---

### 1. Data Ingestion (Náº¡p dá»¯ liá»‡u)

ÄÃ¢y lÃ  quy trÃ¬nh offline Ä‘á»ƒ chuáº©n bá»‹ dá»¯ liá»‡u trÆ°á»›c khi API cÃ³ thá»ƒ cháº¡y.

**ETL (Extract, Transform, Load):**

- **Extract:** Äá»c dá»¯ liá»‡u thÃ´ tá»« CSV báº±ng Pandas.  
- **Transform:** Táº¡o "Corpus" tá»« cÃ¡c cá»™t mÃ´ táº£ + tags.  
- **Load:** LÆ°u dá»¯ liá»‡u Ä‘Ã£ xá»­ lÃ½ vÃ o MongoDB.

**Hybrid Vector (Vector Lai):**  
Káº¿t há»£p Sparse + Dense:

- **Sparse Vector (TF-IDF):** so khá»›p tá»« khÃ³a.  
- **Dense Vector (Sentence-BERT â€“ â€œkeepitreal/vietnamese-sbertâ€):** so khá»›p ngá»¯ nghÄ©a.

**Vector Concatenation:**  
GhÃ©p TF-IDF + SBERT thÃ nh má»™t vector lai duy nháº¥t.

**Model Fitting & Saving:**  
TF-IDF Ä‘Æ°á»£c fit trÃªn toÃ n bá»™ corpus, sau Ä‘Ã³ lÆ°u báº±ng Joblib Ä‘á»ƒ sá»­ dá»¥ng lÃºc runtime.

---

### 2. Runtime API (Quy trÃ¬nh RAG)

Quy trÃ¬nh xá»­ lÃ½ online khi API nháº­n yÃªu cáº§u tá»« ngÆ°á»i dÃ¹ng.

**FastAPI Lifespan:**  
Táº£i mÃ´ hÃ¬nh TF-IDF Ä‘Ã£ lÆ°u vÃ o bá»™ nhá»› khi server khá»Ÿi Ä‘á»™ng.

**Query Vectorization:**  
Truy váº¥n cá»§a user â†’ vector lai (TF-IDF + SBERT).

**Retrieval Stage:**  

- **MongoDB Atlas Vector Search** qua `$vectorSearch`.  
- **Pre-filtering:** lá»c theo `tags_array`.  
- **Vector Similarity:** tÃ¬m top-k Ä‘iá»ƒm Ä‘áº¿n phÃ¹ há»£p.

**Generation Stage:**

- **Prompt Engineering:** chÃ¨n context vÃ o template.  
- **LLM Invocation:** gá»i Ollama vá»›i model tá»« biáº¿n mÃ´i trÆ°á»ng `LLM_MODEL_NAME`.  
- **JSON Parsing:** trÃ­ch JSON sáº¡ch khá»i output cá»§a LLM.  
- **Configuration Management:** dÃ¹ng Pydantic Settings Ä‘á»ƒ táº£i config tá»« `.env`.

---

## ğŸ“¥ Example Luá»“ng Dá»¯ Liá»‡u (I/O)

### 1. Input: YÃªu Cáº§u Cá»§a NgÆ°á»i DÃ¹ng

NgÆ°á»i dÃ¹ng gá»­i má»™t POST Ä‘áº¿n `/recommendations`:

```json
{
  "vibe_prompt": "TÃ´i muá»‘n má»™t nÆ¡i yÃªn tÄ©nh, cá»• kÃ­nh Ä‘á»ƒ chá»¥p áº£nh vÃ  tÃ¬m hiá»ƒu vÄƒn hÃ³a.",
  "tags": ["VÄƒn hÃ³a", "Lá»‹ch sá»­", "Kiáº¿n trÃºc"]
}
```
### 2. Xá»­ LÃ½ Trung Gian
```
Vector hÃ³a:
vibe_prompt â†’ hybrid vector.

Truy váº¥n:
$vectorSearch + lá»c theo tags.

Táº¡o Prompt:
ChÃ¨n top-5 káº¿t quáº£ vÃ o prompt gá»­i cho LLM.
```
### 3. Output: Pháº£n Há»“i Tá»« API
```
LLM táº¡o JSON â†’ API tráº£ vá»:

Sao chÃ©p mÃ£
{
  "status": "success",
  "recommendations": [
    {
      "rank": 1,
      "name": "Phá»‘ cá»• Há»™i An",
      "justification_summary": "Phá»‘ cá»• Há»™i An lÃ  lá»±a chá»n hoÃ n háº£o...",
      "estimated_budget": "...",
      "suggested_activities": ["Tham quan ChÃ¹a Cáº§u", "Äi thuyá»n trÃªn sÃ´ng HoÃ i"]
    },
    {
      "rank": 2,
      "name": "HoÃ ng thÃ nh Huáº¿",
      "justification_summary": "HoÃ ng thÃ nh Huáº¿ mang Ä‘áº­m dáº¥u áº¥n...",
      "estimated_budget": "...",
      "suggested_activities": ["Tham quan Äáº¡i Ná»™i", "Nghe nhÃ£ nháº¡c cung Ä‘Ã¬nh"]
    }
  ],
  "debug_info": {
    "retrieved_count": 5,
    "top_match_score": 0.9123
  }
}
```
